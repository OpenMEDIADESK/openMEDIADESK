<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
  PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
  "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Folder">

    <select id="getFolderById" parameterClass="int" resultClass="com.stumpner.mediadesk.folder.FolderMultiLang">
        SELECT
            categoryid      as categoryId,
            cattitle        as catTitle,
            catname         as catName,
            description     as description,
            descriptionlng1 as descriptionLng1,
            descriptionlng2 as descriptionLng2,
            parent          as parent,
            changeddate     as changedDate,
            imagecount      as imageCount,
            imagecounts     as imageCountS,
            icon            as icon,
            cattitlelng1    as catTitleLng1,
            cattitlelng2    as catTitleLng2,
            sortby          as sortBy,
            orderby         as orderBy,
            defaultview     as defaultview,
            createdate      as createDate,
            primaryivid     as primaryIvid,
            categorydate    as categoryDate,
            creatoruserid   as creatorUserId,
            fid             as fid,
            public          as publicAcl,
            inheritacl      as inheritAcl,
            protected       as protectedAcl
        FROM folder
        WHERE categoryid = #value#
    </select>
    
    <select id="getFolderByName" parameterClass="java.lang.String" resultClass="com.stumpner.mediadesk.folder.FolderMultiLang">
        SELECT
            categoryid      as categoryId,
            cattitle        as catTitle,
            catname         as catName,
            description     as description,
            descriptionlng1 as descriptionLng1,
            descriptionlng2 as descriptionLng2,
            parent          as parent,
            changeddate     as changedDate,
            imagecount      as imageCount,
            imagecounts     as imageCountS,
            icon            as icon,
            cattitlelng1    as catTitleLng1,
            cattitlelng2    as catTitleLng2,
            descriptionlng1     as descriptionLng1,
            descriptionlng2     as descriptionLng2,
            sortby          as sortBy,
            orderby         as orderBy,
            defaultview     as defaultview,
            createdate      as createDate,
            primaryivid     as primaryIvid,
            categorydate    as categoryDate,
            creatoruserid   as creatorUserId,
            fid             as fid,
            public          as publicAcl,
            inheritacl      as inheritAcl,
            protected       as protectedAcl
        FROM folder
        WHERE catname = #value#
    </select>

    <resultMap id="folderList" class="com.stumpner.mediadesk.folder.FolderMultiLang">
        <result property="categoryId" column="categoryid"/>
        <result property="catTitle" column="cattitle"/>
        <result property="catName" column="catname"/>
        <result property="description" column="description"/>
        <result property="parent" column="parent"/>
        <result property="changedDate" column="changeddate"/>
        <result property="imageCount" column="imagecount"/>
        <result property="imageCountS" column="imagecounts"/>
        <result property="icon" column="icon"/>
        <result property="sortBy" column="sortby"/>
        <result property="orderBy" column="orderby"/>
        <result property="catTitleLng1" column="cattitlelng1"/>
        <result property="catTitleLng2" column="cattitlelng2"/>
        <result property="usedLanguage" column="usedLanguage"/>
        <result property="descriptionLng1" column="descriptionlng1"/>
        <result property="descriptionLng2" column="descriptionlng2"/>
        <result property="defaultview" column="defaultview"/>

        <result property="createDate" column="createdate"/>
        <result property="primaryIvid" column="primaryivid"/>
        <result property="categoryDate" column="categorydate"/>
        <result property="creatorUserId" column="creatoruserid"/>
        <result property="fid" column="fid"/>

        <result property="publicAcl" column="public"/>
        <result property="inheritAcl" column="inheritacl"/>
        <result property="protectedAcl" column="protected"/>
    </resultMap>
    <statement id="getFolderList" parameterClass="com.stumpner.mediadesk.core.database.sc.loader.FolderLoaderClass" resultMap="folderList">
        SELECT  folder.categoryid,
                cattitle,
                catname,
                description,
                descriptionlng1,
                descriptionlng2,
                parent,
                changeddate,
                imagecount,
                imagecounts,
                icon,
                sortby,
                orderby,
                defaultview,
                cattitlelng1,
                cattitlelng2,
                '$usedLanguage$' as usedLanguage,
                createdate      as createDate,
                primaryivid     as primaryIvid,
                categorydate    as categoryDate,
                creatoruserid   as creatorUserId,
                fid             as fid,
                public,
                inheritacl,
                protected
            FROM folder
         WHERE parent = #id#
        <isEqual compareValue="1" property="sort">
         ORDER BY catname, cattitle DESC
        </isEqual>
        <isEqual compareValue="2" property="sort">
         ORDER BY cattitle DESC
        </isEqual>
        <isEqual compareValue="3" property="sort">
         ORDER BY createdate DESC
        </isEqual>
        <isEqual compareValue="4" property="sort">
         ORDER BY categorydate DESC
        </isEqual>
    </statement>

    <statement id="getAllCategoryList" parameterClass="com.stumpner.mediadesk.core.database.sc.loader.SimpleLoaderClass" resultMap="folderList">
        SELECT categoryid,
               cattitle,
               catname,
               description,
               descriptionlng1,
               descriptionlng2,
               parent,
               changeddate,
               imagecount,
               imagecounts,
               icon,
               sortby,
               orderby,
               defaultview,
               cattitlelng1,
               cattitlelng2
                 , '$usedLanguage$' as usedLanguage,
                createdate      as createDate,
                primaryivid     as primaryIvid,
                categorydate    as categoryDate,
                creatoruserid   as creatorUserId,
                fid             as fid,
                public,
                inheritacl,
                protected
        FROM folder
        ORDER BY catname ASC
    </statement>

    <statement id="getAllFolderListIc" resultMap="folderList">
        SELECT  folder.categoryid,
                cattitle,
                catname,
                description,
                descriptionlng1,
                descriptionlng2,
                parent,
                changeddate,
                count(folderholder.ivid) as imagecount,
                imagecounts,
                icon,
                sortby,
                orderby,
                defaultview,
                cattitlelng1,
                cattitlelng2
                 , '0' as usedLanguage,
                createdate      as createDate,
                primaryivid     as primaryIvid,
                categorydate    as categoryDate,
                creatoruserid   as creatorUserId,
                fid             as fid,
                public,
                inheritacl,
                protected
            FROM folderholder
            RIGHT OUTER JOIN folder ON folderholder.categoryid = folder.categoryid
            GROUP BY folder.categoryid
         ORDER BY cattitle DESC
    </statement>
    
    <statement id="getFolderListFromMediaObject" parameterClass="com.stumpner.mediadesk.core.database.sc.loader.SimpleLoaderClass" resultMap="folderList">
        SELECT  folder.categoryid,
                cattitle,
                catname,
                description,
                descriptionlng1,
                descriptionlng2,
                parent,
                changeddate,
                imagecount,
                imagecounts,
                icon,
                sortby,
                orderby,
                defaultview,
                cattitlelng1,
                cattitlelng2
                 , '$usedLanguage$' as usedLanguage,
                createdate      as createDate,
                primaryivid     as primaryIvid,
                categorydate    as categoryDate,
                creatoruserid   as creatorUserId,
                fid             as fid,
                public,
                inheritacl,
                protected
            FROM folder
         LEFT OUTER JOIN folderholder ON folder.categoryid = folderholder.categoryid
         WHERE folderholder.ivid = #id#
         GROUP BY folder.categoryid
         ORDER BY catname ASC
    </statement>
    
    <!-- with mysql 4.1 (subselects) -->
    <!--
    <statement id="getCategorySubTree" parameterClass="int" resultMap="folderList">
        SELECT  folder.categoryid,
                cattitle,
                catname,
                description,
                parent
            FROM folder
         WHERE parent = #value# OR parent IN
         (SELECT categoryid FROM folder WHERE parent = #value#)
         ORDER BY parent DESC
    </statement>
    -->
    <!-- without subselects -->
    <statement id="getFolderSubTree" parameterClass="com.stumpner.mediadesk.core.database.sc.loader.FolderLoaderClass" resultMap="folderList">
        SELECT DISTINCT 
                folder.categoryid,
                folder.cattitle,
                folder.catname,
                folder.description,
                folder.descriptionlng1,
                folder.descriptionlng2,
                folder.parent,
                folder.changeddate,
                folder.imagecount,
                folder.imagecounts,
                folder.icon,
                folder.sortby,
                folder.orderby,
                folder.defaultview,
                folder.cattitlelng1,
                folder.cattitlelng2
                 , '$usedLanguage$' as usedLanguage,
                folder.createdate      as createDate,
                folder.primaryivid     as primaryIvid,
                folder.categorydate    as categoryDate,
                folder.creatoruserid   as creatorUserId,
                folder.fid             as fid,
                folder.public          as public,
                folder.inheritacl      as inheritacl,
                folder.protected       as protected
            FROM folder
         LEFT OUTER JOIN folder as cat ON cat.categoryid = folder.parent
         WHERE folder.parent = #id# OR cat.parent = #id#
        <isEqual property="usedLanguage" compareValue="1">                        
            <isEqual compareValue="1" property="sort">
             ORDER BY folder.catname, folder.cattitlelng1 ASC
            </isEqual>
            <isEqual compareValue="2" property="sort">
             ORDER BY folder.cattitlelng1 ASC
            </isEqual>
            <isEqual compareValue="3" property="sort">
             ORDER BY createdate DESC
            </isEqual>
            <isEqual compareValue="4" property="sort">
             ORDER BY categorydate DESC
            </isEqual>
        </isEqual>
        <isEqual property="usedLanguage" compareValue="2">
            <isEqual compareValue="1" property="sort">
             ORDER BY folder.catname, folder.cattitlelng2 ASC
            </isEqual>
            <isEqual compareValue="2" property="sort">
             ORDER BY folder.cattitlelng2 ASC
            </isEqual>
            <isEqual compareValue="3" property="sort">
             ORDER BY createdate DESC
            </isEqual>
            <isEqual compareValue="4" property="sort">
             ORDER BY categorydate DESC
            </isEqual>
        </isEqual>
    </statement>

    <select id="getMaxFolderId"
        parameterClass="int"
        resultClass="int">
        SELECT
            MAX(categoryid) as value
        FROM folder
    </select>

    <insert id="addFolder" parameterClass="com.stumpner.mediadesk.folder.FolderMultiLang">
        INSERT INTO
        folder (cattitle,catname,description,parent,changeddate,imagecount,imagecounts,cattitlelng1,cattitlelng2,descriptionlng1,descriptionlng2,icon,sortby,orderby,defaultview,createdate,primaryivid,categorydate,creatoruserid,fid,public,inheritacl,protected)
        VALUES (#catTitle#,#catName#,#description#,#parent#,#changedDate#,#imageCount#,#imageCountS#,#catTitleLng1#,#catTitleLng2#,#descriptionLng1#,#descriptionLng2#,#icon#,#sortBy#,#orderBy#,#defaultview#,#createDate#,#primaryIvid#,#categoryDate#,#creatorUserId#,#fid#,#publicAcl#,#inheritAcl#,#protectedAcl#)
    </insert>

    <insert id="addMediaToFolder" parameterClass="com.stumpner.mediadesk.folder.FolderHolder">
        INSERT INTO
        folderholder (categoryid,ivid)
        VALUES (#categoryId#,#ivid#)
    </insert>

    <delete id="deleteMediaFromFolder" parameterClass="com.stumpner.mediadesk.folder.FolderHolder">
        DELETE FROM folderholder
        WHERE categoryid = #categoryId# AND ivid = #ivid#
    </delete>

    <delete id="deleteAllMediaFromFolder" parameterClass="int">
        DELETE FROM folderholder
        WHERE categoryid = #categoryId#
    </delete>

    <delete id="deleteMediaFromAllFolders" parameterClass="int">
        DELETE FROM folderholder
        WHERE ivid = #ivid#
    </delete>

    <delete id="deleteFolderById" parameterClass="int">
        DELETE FROM folder
        WHERE categoryid = #categoryId#
    </delete>

    <update id="saveFolder" parameterClass="com.stumpner.mediadesk.folder.FolderMultiLang">
        UPDATE folder
        SET cattitle = #catTitle#,
            catname = #catName#,
            parent = #parent#,
            description = #description#,
            descriptionlng1 = #descriptionLng1#,
            descriptionlng2 = #descriptionLng2#,
            changeddate = #changedDate#,
            imagecount = #imageCount#,
            imagecounts = #imageCountS#,
            icon = #icon#,
            sortby = #sortBy#,
            orderby = #orderBy#,
            defaultview = #defaultview#,
            cattitlelng1 = #catTitleLng1#,
            cattitlelng2 = #catTitleLng2#,
            createdate = #createDate#,
            primaryivid = #primaryIvid#,
            categorydate = #categoryDate#,
            creatoruserid = #creatorUserId#,
            fid = #fid#,
            public = #publicAcl#,
            protected = #protectedAcl#,
            inheritacl = #inheritAcl#
        WHERE categoryid = #categoryId#
    </update>

    <select id="isMediaInFolder"
        parameterClass="com.stumpner.mediadesk.core.database.sc.loader.HolderClass"
        resultClass="int">
        SELECT
            COUNT(*) as value
        FROM folderholder WHERE categoryid = #objectId# AND ivid = #ivid#
    </select>

    <select id="getFolderIdByFid"
        parameterClass="java.lang.String"
        resultClass="int">
        SELECT
            categoryid as value
        FROM folder
        WHERE fid = #fid#
    </select>

</sqlMap>