package com.stumpner.mediadesk.web.mvc;

import org.springframework.web.servlet.ModelAndView;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.stumpner.mediadesk.image.inbox.InboxService;
import com.stumpner.mediadesk.image.folder.Folder;
import com.stumpner.mediadesk.core.database.sc.FolderService;
import com.stumpner.mediadesk.core.database.sc.exceptions.ObjectNotFoundException;
import com.stumpner.mediadesk.core.database.sc.exceptions.IOServiceException;

/**
 * Created by IntelliJ IDEA.
 * User: franzstumpner
 * Date: 27.04.2005
 * Time: 21:27:43
 * To change this template use File | Settings | File Templates.
 */
public class InboxViewController extends AbstractPageController {

    protected ModelAndView handleRequestInternal(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse) throws Exception {

        //select action
        if (httpServletRequest.getParameter("folderId")!=null) {
            //zu folder...
            System.out.println("to folder..."+httpServletRequest.getParameter("folderId"));
            if (!httpServletRequest.getParameter("folderId").equals("0")) {
                this.addImagesToFolder(
                        httpServletRequest.getParameter("folderId"),
                        httpServletRequest.getParameterValues("ivid"));
            }
        }

        InboxService inboxService = new InboxService();
        model.put("imageList",inboxService.getInbox());

        FolderService folderService = new FolderService();
        model.put("folderList",folderService.getFolderList(50));

        this.setContentTemplateFile("inbox.jsp",httpServletRequest);

        return super.handleRequestInternal(httpServletRequest, httpServletResponse);    //To change body of overridden methods use File | Settings | File Templates.
    }

    private void addImagesToFolder(String sfolderId, String[] sivids) {

        int folderId = Integer.parseInt(sfolderId);
        FolderService folderService = new FolderService();
        InboxService inboxService = new InboxService();
        int lastImageIvid = 0;

        for (int p=0;p<sivids.length;p++) {
            int ivid = Integer.parseInt(sivids[p]);
            folderService.addImageToFolder(folderId,ivid);
            lastImageIvid = ivid;
            inboxService.removeImage(ivid);
        }

        try {
            Folder folder = folderService.getFolderById(folderId);
            folder.setPrimaryIvid(lastImageIvid);
            folderService.save(folder);
        } catch (ObjectNotFoundException e) {
            e.printStackTrace();  //To change body of catch statement use File | Settings | File Templates.
        } catch (IOServiceException e) {
            e.printStackTrace();  //To change body of catch statement use File | Settings | File Templates.
        }
    }



}
